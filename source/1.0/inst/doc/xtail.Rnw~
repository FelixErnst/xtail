%\VignetteIndexEntry{xtail}
%\VignetteDepends{xtail}
%\VignetteKeywords{xtail}
%\VignettePackage{xtail}
%\VignetteEngine{knitr::knitr}

% To compile this document
% library('knitr');rm(list=ls());knit('xtail.Rnw')

\documentclass[a4paper]{article}
\newcommand{\lowtilde}{\raise.17ex\hbox{$\scriptstyle\mathtt{\sim}$}}
<<knitr, echo=FALSE, results="hide">>=
library("knitr")
@

\title{Translational differential analysis of ribosome profiling data \\-- the Xtail package}
\author{Zhengtao Xiao$^{1-3}$, Qin Zou$^{1,3}$, Yu Liu$^{1-3}$, and Xuerui Yang$^{1-3}$
\\[1em] \small{$^{1}$MOE Key Laboratory of Bioinformatics, }
\\ \small{$^{2}$Tsinghua-Peking Joint Center for Life Sciences,}
\\ \small{$^{3}$School of Life Sciences, Tsinghua University, Beijing 100084, China.}}

<<<style,eval=TRUE,echo=FALSE,results='asis'>>=
BiocStyle::latex()
@


\begin{document}

<<include=FALSE>>=
library(knitr)
opts_chunk$set(
concordance=TRUE
)
@

\maketitle
\section{Introduction}

This vignette is intended to explain the use of the package. This package is for identifing genes undergoing differential translation with ribosome profiling data. The analysis procedure or ribosome profiling has to integrate data from both mRNA and RPF, to differentiate translational dysregulations from changes at the stage of mRNA expression. Our method adapted the differential expression analysis strategy of \verb'DESeq2'\cite{DESeq2} to quantify the magnitude and significance of translational changes by a pairwise comparison the deviation of the two fold changes of mRNA and RPF across conditions.

Our model assume negative binomial distributions of read counts for both mRNA and RPF. We derived probability distributions of log2 fold changes (log2FC) of mRNA and RPF across two experimental conditions, as well as log2 ratios (log2R) of RPF over mRNA in each of the two experimental conditions . Two p-values by comparing log2FC or log2R probability distributions are calculated and finally the larger one was select as the final P-values for differential translations. 

Here we perform analysis on the ribosome profiling data and shown the base usage of our package. 

\section{Data Preparation}

As input, the \verb'Xtail' package uses raw read counts of RPF and mRNA, in the form of rectangular table of integer values. The rows and the columns of the table correspond the genes and samples. Each cell in the \textsl{i-th} row and the \textsl{j-th} columns is the count number of reads mapped to gene \textsl{i} in sample \textsl{j}. The mRNA count data and RPF count data are stored in two text files. We can read them in using \textbf{R}'s standard function. For example,

<<>>=
mrna <- read.table("mRNA_counts.txt", header=TRUE, row.names=1)
rpf <- read.table("RPF_counts.txt", header=TRUE,row.names=1)
@


Here, header=TRUE indicates that the first line contains columns names and row.names=1 means that the first column should be used as row names (genes names).

In this vignette, we selected a published ribosome profiling dataset from yeast after amino acid starvation\cite{Ingolia}. This dataset consisting of 5000 genes from two conditions ("rich" vs. "starvation") with each condition having two replicates. We can load this dataset by,
<<>>=
library(xtail)
data(testdata)
@

\section{An Example}

Here we perform an analysis on the ribosome profiling data described above. First we load the library and data.

<<>>=
library(xtail)
data(testdata)
@


Next we can have a look at the first five lines of the mRNA (\verb'mrna') and RPF (\verb'rpf') elements of \verb'testdata'.

<<>>=
#mrna <- testdata$mrna
#rpf <- testdata$rpf
#head(mrna,5)
#head(rpf,5)
@


We assign condition labels corresponding to the columns of the mRNA and RPF inputs.

<<>>=
#condition <- c("rich","rich","starvation","starvation")
@


We run the main function, which is called \verb'xtail()'. By default, the \verb'baseLevel' is set to the first condition (here is "rich"). This control the log2FC or log2R as the expected comparison against the baseLevel. The argument \verb'minMeanCount' is set to 10. This is the minimum average expression of mRNA counts and RPF counts acrossing all experiments for a gene to be used. The argument threadsNo is the number of CPU cores for using. By default, \verb'threadsNo' is set to 'NA', so the \verb'detectCores' function in \verb'parallel' library is used to determine the available cores. The argument \verb'bins' is the number of bins used for calculate the probability densities of log2FC and log2R. This paramater will determine how accurate the final pvalue. Here, in order to keep the run-time of this vignette small, we will set \verb'bins' to '1000'.

<<>>=
#test.results <- xtail(mrna,rpf,coundition,bins=1000)
@


Now we can examine the first five lines of the results produced by the \verb'xtail()' run.

<<inspectData,echo=TRUE>>=
#head(test.results,5)
@


The elements \verb'mRNA_log2FC' and \verb'RPF_log2FC' are log2 fold changes of mRNA and RPF comparson with baseLevel conditon. The \verb'OVL_log2FC' is the overlap coefficence between mRNA and RPF log2FC distributions, which suggest coordinated RPF and mRNA changes. Smaller OVL suggest uncoordinated changes of RPF and mRNA across different coditions, supporting differential translations. \verb'pvalue_log2FC' tells us the statistical significance of differential translations, with low being interesting. The \verb'rich_log2R', \verb'starvation_log2R', \verb'OVL_log2R', \verb'pvalue_log2R' have similar meaning, but represent log2 ratio of RPF over mRNA in each condition. The \verb'final_pvalues' is the final pvalue which is the larger one of \verb'pvalue_log2FC' and \verb'pvalue_logR'. The \verb'FDR' is the estimated false discovery rate corresponding to the gene for the \verb'final_pvalue'.

Finally, the plain-text file of the results can be exported using the base \textbf{R} functions \textsl{write.csv} or \textsl{write.table}.

<<>>=
#write.table(test.results,"test_results.txt",quote=F,sep="\t")
@


\section*{Session Info}

<<sessInfo>>=
sessionInfo()
@


\begin{thebibliography}{99}
\bibitem{DESeq2} Attila Molnar and Charles W. Bassett and Thomas J. Hardcastle and Ruth Dunn and David C. Bauclombe \textsl{Small silencing RNAs in plants are mobile and direct epigenetic modification in recipient cells.} Science (2010).
\bibitem{Ingolia} Mark Robinson \verb'edgeR'\textsl{:' Methods for differential expression in digital gene expression datasets}. Bioconductor.
\end{thebibliography}


\end{document}
